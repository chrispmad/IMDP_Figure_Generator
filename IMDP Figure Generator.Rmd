---
title: "IMDP Figure Generator"
author: "Chris Madsen"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
pacman::p_load(
readxl,
ggpubr,
ggrepel,
tidyverse,
sf,
RColorBrewer,
openxlsx,
lubridate,
plotrix)

rm(list=ls())

#=====================================================
#                       OPTIONS 
#=====================================================
#Which year should we focus on?
my.year = 2021

#Update GIS maps? We probably want this turned on unless you are making fine adjustments to some figures.
update.gis = FALSE

#Are there any stations we would like to exclude from the excel-type figures?
#In 2021, we will exclude:
stations.to.include = c("Golden","Radium","Olsen","Yahk",
                        "Pacific","Osoyoos","Hwy 97c","Mt. Robson",
                        "Keremeos","Greenwood","Dawson Creek","Kaleden")

stations.to.put.aside = c("Scheduled Inspection","Boat Launch - Okanagan",
                          "Penticton Roving - Hwy 33", 
                          "Penticton Roving - Inspection Event")

#Where is the mussel-fouled tracking sheet?
MusselFouledTracker = "I:/SPECIES/Zebra_Quagga_Mussel/Operations/Watercraft Inspection Data/2021 data/Mussel fouled boats tracking sheet 2021-08-20.xlsx"

#What is the sheet name of the destination regions for the mussel fouled tracking sheet?
MF_tracker_sheet = "DestRegions"

#Where can we find the CBSA notifications excel sheet for this year?
cbsa_dat = read_excel("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/2021/GIS Maps and Excel Figures/2021 COS inbox notifications.xlsx",
                 sheet = "Filtered list")

#=====================================================
#                     END OF OPTIONS
#=====================================================

#If there is no folder for excel figures for the target year in the I: drive, make it now.
if(!dir.exists(paste0("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/",my.year,"/GIS Maps and Excel Figures/ExcelFigures"))){
  dir.create(paste0("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/",my.year,"/GIS Maps and Excel Figures/ExcelFigures/"))
}

#These lines below set options for all of the code for the rest of this script. You probably don't need to change any of these.
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width = 8)
knitr::opts_chunk$set(fig.height = 4)
knitr::opts_knit$set(root.dir = paste0( "I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/",my.year,"/GIS Maps and Excel Figures/ExcelFigures/"))
```

## `r print(my.year)` IMDP Final Report Figures

```{r import_data}
#Read in data (cleaned). These data do not have any of the "test" records from metabase.
dat_all = read_excel("I:/SPECIES/Zebra_Quagga_Mussel/Operations/Watercraft Inspection Data/Multiyear data/WatercraftInspectionData_AllYears_Selected_Columns.xlsx",
                     col_type = "text")

#Get Station coordinates, might be unnecessary.
stations = read_sf("W:/CSilverio/2019 Invasive Mussel Program Final Report Maps/Data/Shp_Lyr_Dbase/Figure01_2019_Watercraft_Inspection_Stations.shp") %>% 
  bind_rows(data.frame(Station_Na = c("Balfour","Castlegar","Elko","Midway","Penticton Roving",
                            "Scheduled Inspection","Keremeos"),
            Map_label_ = c("Balfour","Castlegar","Elko","Midway","Penticton Roving","","Keremeos"),
            Lat = c(49.62,49.29,49.30,49.01,49.49,49.49,49.20),
            Lat_geom = c(49.62,49.29,49.30,49.01,49.49,49.49,49.20),
            Long = c(-116.96,-117.64,-115.11,-118.78,-119.59,-119.59,-119.83),
            Long_geom = c(-116.96,-117.64,-115.11,-118.78,-119.59,-119.59,-119.83),
            HoursOfOpe = rep("Unknown",7),
            StationTyp = rep("Unknown",7)) %>% 
  st_as_sf(coords = c("Long_geom","Lat_geom"),crs=4326)) %>% 
  st_transform(crs = 3005)

#Lookup table of provinces/territories and U.S. States (full names and abbreviations)
abbrev = read_excel("W:/CMadsen/SpatialData/Province_States_Abbreviation_Table.xlsx")

#Lookup table for named waterbodies in BC and which FLNRO fisheries region they can be found in. 
flnro_lookup = read_excel("W:/CMadsen/SpatialData/waterbody_name_flrno_region_lookup_table.xlsx") %>% distinct()

#Lookup table for what the Previous Knowledge of AIS field's codes mean.
ais_know = read_excel("W:/CMadsen/SpatialData/Previous_Knowledge_of_AIS_lookup_table.xlsx")
```

```{r data_cleaning}
#Fix some inconsistencies in station name spelling.
dat_all = dat_all %>% 
  mutate(Station = case_when(
    Station == "Cascade Border" ~ "Cascade",
    str_detect(Station, "Cutts") ~ "Cutts (Hwy 93)",
    Station == "Hwy 93 Columbia Lake" ~ "Cutts (Hwy 93)",
    Station == "Olsen (Hwy 3)" ~ "Olsen",
    Station == "Valemount" ~ "Mt. Robson",
    str_detect(Station, "Pacific") ~ "Pacific",
    Station == "Keremeos (Hwy 3)" ~ "Keremeos",
    str_detect(Station, "^Schedule") ~ "Scheduled Inspection",
    str_detect(Station, "Covid") ~ "COVID Border",
    str_detect(Station, "Penticton") ~ "Penticton Roving",
    str_detect(Station, "Okanagan") ~ "Okanagan",
    T ~ Station
  ))

#We need to clean up the field(s) that talk about which province/state a given inspection is from.
dat_all = dat_all %>% 
  #Make the name shorter for now...
  rename(Source = Previous_Waterbody_1_Province_Or_State) %>% 
  #Replace NA in Source with previous major city, if we have it. If not, use the province_code of the boat. If we don't have any of those, or if the Source field wasn't blank, keep it as it was.
  mutate(NewSource = case_when(
    (Source == "Unknown" | is.na(Source)) & !is.na(Previous_Major_City) & Previous_Major_City != "None" ~ Previous_Major_City,
    (Source == "Unknown" | is.na(Source)) & (is.na(Previous_Major_City) | Previous_Major_City == "None") ~ Province_Code,
    T ~ Source)) %>% 
  #If we replaced the Source field with the closest major city, we need to pull the province/state name out of the string.
  mutate(NewSource = case_when(
    str_detect(NewSource, ",.*,") ~ str_extract(NewSource, "(?<=, ).*(?=,)"),
    T ~ NewSource)) %>%
  #Finally, change the long form (e.g. "Alberta") to abbreviated form for names (e.g. "AB").
  left_join(abbrev %>% rename(NewSource = Province_or_State)) %>% 
  mutate(NewSource = coalesce(Abbrev,NewSource)) %>% 
  dplyr::select(-Abbrev,-Source) %>% 
  rename(Previous_Waterbody_1_Province_Or_State = NewSource)
```

```{r calculate_total_boats_and_convert_to_datetime}
#Add total boats (multiply inspections by boat type counters)
dat_all = dat_all %>% 
  mutate(TotalBoats = as.numeric(Non_Motorized_Counter) + 
                      as.numeric(Simple_Counter) + 
                      as.numeric(Complex_Counter) + 
                      as.numeric(Very_Complex_Counter)) %>% 
  mutate(TotalBoats = replace(TotalBoats, TotalBoats == 0, 1))

#Convert start_time, end_time and TimeOfInspection to datetime format.
dat_all$Start_Time = convertToDateTime(dat_all$Start_Time)
dat_all$End_Time = convertToDateTime(dat_all$End_Time)
dat_all$TimeOfInspection = convertToDateTime(dat_all$TimeOfInspection)

dat_all = dat_all %>% 
  mutate(Shift_hours = as.numeric(End_Time - Start_Time)/3600)
```

```{r correct_negative_shift_length_data}
dat_all = dat_all %>% 
  mutate(Shift_hours = ifelse(Shift_hours < 0, -Shift_hours, Shift_hours))

```

```{r add_shift_unique_identifier}
#Add a unique identifier for each shift. I'm using combinations of start and end time
#so hopefully they are unique.
dat_all = dat_all %>% 
  group_by(Start_Time, End_Time) %>% 
  mutate(Shift_ID = cur_group_id()) %>% 
  select(Year,Shift_ID,everything()) %>% 
  arrange(Shift_ID) %>% 
  ungroup()
```

```{r data_for_maps}
### Make Data for 2021 GIS maps
if(update.gis == T){
#First, we need to get total inspections, HR inspections, and mussel-fouled inspections by source location.

#Source locations...
na_sf = read_sf("W:/CMadsen/SpatialData/NorthAmerica_ProvState.shp") %>% 
  filter(!NAME_1 %in% c("Coahuila","Hidalgo"))

#Cleaning up previous waterbody 1 prov/state field...
source_dat = dat_all %>%
  rename(ABBR = Previous_Waterbody_1_Province_Or_State) %>% 
  mutate(ABBR = case_when(
    ABBR == "unknown" ~ "Unknown",
    ABBR == "Calgary" ~ "AB",
    ABBR == "Mexico" ~ "BN",
    ABBR == "Wi" ~ "WI",
    ABBR == "Radium" ~ "BC",
    ABBR == "Sk" ~ "SK",
    ABBR == "SA" ~ "SK",
    ABBR == "Ab" ~ "AB",
    ABBR == "QB" ~ "QC",
    ABBR == "Yukon Territory" ~ "YT",
    ABBR == "YK" ~ "YT",
    ABBR == "Northwest Territories" ~ "NT",
    ABBR == "NWT" ~ "NT",
    ABBR == "W" ~ "WA",
    ABBR == "LI" ~ "LA",
    ABBR == "KA" ~ "KS",
    T ~ ABBR
  )) %>% 
  filter(Year == my.year)

# source_dat %>% 
#   count(ABBR, name = "Total") %>%
#   arrange(desc(Total))

#Join total insp, HR insp, MS insp, and commercially hauled insp, to north america shapefile.
insp_by_source = na_sf %>% 
  left_join(source_dat %>% count(ABBR) %>% rename(TotalInsp = n)) %>% 
  left_join(source_dat %>% 
              filter(High_Risk_AIS_Ind == T,
                     Clean_Drain_Dry_After_Inspection_Ind == F) %>% 
              count(ABBR) %>% 
              rename(HRInsp = n)) %>% 
  left_join(source_dat %>% 
              filter(MusselsFound_Ind == T) %>% 
              count(ABBR) %>%
              rename(MFInsp = n)) %>% 
  left_join(source_dat %>% 
              filter(Commercially_Hauled_Ind == T) %>% 
              count(ABBR) %>%
              rename(CHInsp = n)) %>% 
  st_centroid()
  

write_sf(insp_by_source,"W:/CMadsen/2021 Invasive Mussel Program Final Report Maps/data/ShapeLayers/Inspections_by_source_centroid.shp")

# And also to write out inspection data joined to stations.
stations = read_sf("W:/CMadsen/2021 Invasive Mussel Program Final Report Maps/data/ShapeLayers/Watercraft_Inspection_Stations_Update.shp") %>% 
  bind_rows(data.frame(Label_name = c("Balfour","Castlegar","Elko","Midway","Penticton Roving","Scheduled Inspection","Salmo","Cutts (Hwy 93)"),
            Lat = c(49.62,49.29,49.30,49.01,49.49,49,49.19,49.276),
            Long = c(-116.96,-117.64,-115.11,-118.78,-119.59,-125,-117.28, -115.128),
            Type = c(rep("Permanent Inspection Station",4),"Roving Inspection Crew",rep("Permanent Inspection Station",3))) %>% 
              mutate(Lat_c = Lat, Long_c = Long) %>% 
  st_as_sf(coords = c("Long_c","Lat_c"),crs=4326) %>% 
  st_transform(crs = 3005))

stations %>% 
  mutate(Label_name = case_when(
    Label_name == "Keremeos (Hwy 3)" ~ "Keremeos",
    Label_name == "Pacific / Surrey" ~ "Pacific",
    T ~ Label_name
  )) %>% 
  filter(Label_name != "Penticton Roving") %>% 
  rename(Station = Label_name) %>% 
  left_join(dat_all %>% group_by(Station,Year,Province_Code) %>% count(name = "TotalInspections")) %>%
  left_join(dat_all %>% group_by(Station,Year,Province_Code) %>% filter(MusselsFound_Ind == T) %>% count(name = "MusselFouled")) %>%
  left_join(dat_all %>% group_by(Station,Year,Province_Code) %>% filter(High_Risk_AIS_Ind == T) %>% count(name = "HighRisk")) %>%
  left_join(dat_all %>% group_by(Station,Year,Province_Code) %>% 
              filter(Province_Code != "Unknown") %>% summarise(number_in_provs = n()) %>% 
              summarise(number_of_provs = n())) %>% 
  distinct() %>%
  group_by(Station,Year) %>% 
  mutate(row.number = row_number()) %>% 
  select(Year, everything()) %>% 
  select(-Province_Code,-row.number) %>% 
  group_by(Year,Station) %>% 
  mutate(TotalInspections = sum(TotalInspections, na.rm=T),
         MusselFouled = sum(MusselFouled, na.rm=T),
         HighRisk = sum(HighRisk, na.rm=T)) %>% 
  distinct() %>% 
  #We're missing a couple rows of coordinates... let's get them.
  st_transform(crs = 4326) %>% 
  mutate(Lat = replace_na(Lat, matrix(unlist(st_geometry(geometry)),byrow=T,ncol=2)[,2]),
         Long = replace_na(Long, matrix(unlist(st_geometry(geometry)),byrow=T,ncol=2)[,1])) %>% 
  write_sf("W:/CMadsen/2021 Invasive Mussel Program Final Report Maps/data/ShapeLayers/Inspections_Summarised_at_Station_level.shp")

#And also to write out inspections (total, HR, MF) by destination location (i.e. waterbody)
#Just for 2021!
#Here are the lake shapefiles for which we have at least 1 inspection from 2015 - present.
lakes = read_sf("W:/CMadsen/SpatialData/summarized_bc_waterbodies_same_gnis_joined.shp")

summaries = read_excel("I:/SPECIES/Zebra_Quagga_Mussel/Operations/Watercraft Inspection Data/Multiyear data/InspectionSummaries_GNISNA_WATERSH_Year.xlsx") %>% 
  filter(Year == my.year)
  
lakes = lakes %>% 
  left_join(summaries) %>% 
  filter(!is.na(TotalInspections)) %>% 
  st_centroid()

write_sf(lakes, "W:/CMadsen/2021 Invasive Mussel Program Final Report Maps/data/ShapeLayers/Inspections by dest waterbodies for target year.shp")
}
```

```{r add_lat_long_for_closest_city_fields}
#Combine the two fields containing closest city info: "Destination_Waterbody_1_Closest_City" and "Destination_Major_City".
dat_all = dat_all %>% 
  mutate(CityName = case_when(
    #When we have info for the closest city field, use that.
    !is.na(Destination_Waterbody_1_Closest_City) & Destination_Waterbody_1_Closest_City != "Other" ~ Destination_Waterbody_1_Closest_City,
    #If we lack closest city but have info in 'Destination_Major_City' (more coarse detail), use that.
    is.na(Destination_Waterbody_1_Closest_City) | Destination_Waterbody_1_Closest_City == "Other" ~ Destination_Major_City,
    T ~ "Unknown"
  )) %>% 
  mutate(CityName = replace_na(CityName, "Unknown")) %>% 
  mutate(CityName = str_remove_all(CityName, ",.*"))

#For inspections that lack a destination waterbody name, use the BC geocoder to get lat/long coordinates for city names. If the dest city is outside BC, don't get lat/long for those, in case there's a tiny town in BC with the same name and we incorrectly get the coordinates for that town. 
city_names_for_coords = tibble(dat_all %>% 
             filter(is.na(Destination_Waterbody_1_Name)) %>% 
             filter(CityName != "Unknown") %>% 
             #Get rid of any that are outside BC. We'll flag those when we make the DestRegion field.
             filter(str_detect(Destination_Major_City, ", British Columbia")) %>% 
             select(CityName) %>% 
             distinct()) 

#Create new variables that we will fill with the loop below.
city_names_for_coords$lon = 0
city_names_for_coords$lat = 0
  
#This loop uses the BC geocoder to find the most likely coordinates
# for each of the unique place names.
for(i in 1:nrow(city_names_for_coords)){
    # Pull out place name.
    my.name = city_names_for_coords[i,]$CityName
    #Clean up names. Remove anything in brackets.
    my.name = str_remove_all(my.name, " \\(.*\\)")
    #Add spaces to names.
    my.name = str_replace_all(my.name, " ", "%20")
    
    url = paste0('https://geocoder.api.gov.bc.ca/addresses.json?addressString=',
                 my.name,'&maxResults=1&outputSRS=4326')
    
    my.coords = jsonlite::fromJSON(url)$features$geometry %>% 
      summarise(lon = str_extract(coordinates, "(?<=c\\().*(?=\\,)"),
                lat = str_extract(coordinates, "(?<=\\,).*(?=\\))"))
    
    city_names_for_coords[i,]$lon = as.numeric(my.coords$lon)
    city_names_for_coords[i,]$lat = as.numeric(my.coords$lat)
}

#Find out which FLRNO region each of these city coords fall into.
flnro_regions = read_sf("W:/CMadsen/SpatialData/FLNRO_Fishing_Boundaries.shp")

city_names_for_coords = city_names_for_coords %>%
  st_as_sf(coords = c("lon","lat"), crs = 4326) %>% 
  st_transform(crs = 3005) %>% 
  st_join(flnro_regions, st_intersects)

#Join those coordinates to dat_all. For inspections with Unknown nearest city, those remain blank for lat and long.
dat_all = dat_all %>% 
  left_join(city_names_for_coords %>% 
              st_drop_geometry() %>% 
              rename(City_region_g = REGION_G,
                     City_region_n = REGION_N))
```

```{r Subset multiyear dataset for this years data}
#Set aside the records for mussel-fouled boats.
dat_mf = dat_all %>% filter(MusselsFound_Ind == T)

#And set aside the records for high-risk boats.
dat_hr = dat_all %>% filter(High_Risk_AIS_Ind == T) %>% 
  filter(Clean_Drain_Dry_After_Inspection_Ind == F | Year < 2020)

dat = dat_all %>% filter(Year == my.year)
```

```{r sort_into_destination_regions}
#We also need to pull together the destination waterbody region from a couple columns.
dat = dat %>% 
  #Combine the 2 categories of destinations that aren't a waterbody.
  mutate(across(c(DestNotBC,OceanBoat,DryStorage), ~na_if(.x,F))) %>% 
  mutate(Dest_not_wb = coalesce(DestNotBC,DryStorage)) %>% 
  mutate(DestRegion = case_when(
    #If we have the destination name, use that.
    !is.na(Destination_Waterbody_1_Name) ~ Destination_Waterbody_1_Name,
    #If we don't have name, but have city, we'll use the city region we found above.
    is.na(Destination_Waterbody_1_Name) & !is.na(City_region_n) ~ City_region_n,
    #If we have no name or city, and either of the categories flagged (e.g. "DestNotBC"), use those.
    Dest_not_wb == T ~ "Outside BC",
    DryStorage == T ~ "Dry Storage",
    T ~ "Unknown"))

#Same thing for our little mussel-fouled table...
dat_mf = dat_mf %>% 
  #Combine the 2 categories of destinations that aren't a waterbody.
  mutate(across(c(DestNotBC,OceanBoat,DryStorage), ~na_if(.x,F))) %>% 
  mutate(Dest_not_wb = coalesce(DestNotBC,DryStorage)) %>% 
  mutate(DestRegion = case_when(
    #If we have the destination name, use that.
    !is.na(Destination_Waterbody_1_Name) ~ Destination_Waterbody_1_Name,
    #If we don't have name, but have city, we'll use the city region we found above.
    is.na(Destination_Waterbody_1_Name) & !is.na(City_region_n) ~ City_region_n,
    #If we have no name or city, and either of the categories flagged (e.g. "DestNotBC"), use those.
    Dest_not_wb == T ~ "Outside BC",
    DryStorage == T ~ "Dry Storage",
    T ~ "Unknown"))

#And same thing for high-risk inspections.
#Same thing for our little mussel-fouled table...
dat_hr = dat_hr %>% 
  #left_join(dat_hr %>% 
  #Combine the 2 categories of destinations that aren't a waterbody.
  mutate(across(c(DestNotBC,OceanBoat,DryStorage), ~na_if(.x,F))) %>% 
  mutate(Dest_not_wb = coalesce(DestNotBC,DryStorage)) %>% 
  mutate(DestRegion = case_when(
    #If we have the destination name, use that.
    !is.na(Destination_Waterbody_1_Name) ~ Destination_Waterbody_1_Name,
    #If we don't have name, but have city, we'll use the city region we found above.
    is.na(Destination_Waterbody_1_Name) & !is.na(City_region_n) ~ City_region_n,
    #If we have no name or city, and either of the categories flagged (e.g. "DestNotBC"), use those.
    Dest_not_wb == T ~ "Outside BC",
    DryStorage == T ~ "Dry Storage",
    T ~ "Unknown"))

 #select(Watercraft_Risk_Assessment_ID,DestRegion))
```

```{r reduce dat_all, dat}
#Set aside four stations that Martina asked for a single excel sheet for.
dat_rovers = dat %>% filter(Station %in% stations.to.put.aside)
dat_all_rovers = dat_all %>% filter(Station %in% stations.to.put.aside)
```

```{r}
#Establish colour scheme for roving stations.
data.frame(unique(dat$Station))
rovers = data.frame(Station = c("Hwy 97C","Keremeos","Greenwood","Kaleden"),
                    StationType = "Roving")

station_types = bind_rows(rovers,
          data.frame(Station = dat %>% 
                       select(Station) %>% 
                       filter(!Station %in% rovers$Station) %>% 
                       distinct() %>% 
                       pull(Station),
                     StationType = "Permanent"))
rm(rovers)
```

### Figure 3 Total Boats by Station

```{r fig3_total_boats_by_station}
p3 = dat %>% 
  filter(!Station %in% c("Scheduled Inspection","Other","Okanagan","Penticton Roving")) %>% 
  group_by(Station) %>% 
  summarise(NumberInsp = n()) %>% 
  left_join(dat_hr %>% 
              filter(Year == my.year) %>% 
              group_by(Station) %>% 
              summarise(NumberHighRiskInsp = n())
            ) %>% 
  #For any stations with 0 HR inspections, replace NA with 0.
  mutate(NumberHighRiskInsp = replace_na(NumberHighRiskInsp, 0)) %>% 
  mutate(PercentHR = 100*NumberHighRiskInsp/NumberInsp) %>% 
  left_join(dat %>% 
  #mutate(the.month = month(Start_Time,label=T,abbr=F)) %>% 
  group_by(Station) %>% 
  select(Station,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalHours = sum(Shift_hours)))  %>% 
  mutate(EncounterFreq = NumberInsp/TotalHours) %>% 
  #Kaleden has no total hours for inspections... remove for now.
  #filter(!is.na(TotalHours)) %>% 
  arrange(desc(EncounterFreq)) %>% 
  mutate(Station = factor(Station)) %>% 
  mutate(Station = fct_inorder(Station)) %>% 
  left_join(station_types) %>% 
  ggplot() + 
  geom_col(aes(x=Station,y=EncounterFreq, fill = StationType), width = 0.40) +
  geom_line(aes(x=Station,y=PercentHR,group=1),col="red",size=2) +
  scale_y_continuous(name = "Encounter Frequency",
                     sec.axis = sec_axis(~., name = "% High Risk",
                                         breaks = seq(0,8,2))) +
  # geom_text(aes(x=Station,y=EncounterFreq+max(EncounterFreq)*0.05,
  #               label=round(EncounterFreq,0))) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency") +
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p3

ggsave("Fig3_EncounterFrequency_HR.jpg",p3)
```

### Figure 3.x Total Inspections by Station

```{r}
p3.x = dat_all %>% 
  filter(Year %in% c(2019:2021)) %>% 
  filter(Station %in% c("Golden","Yahk","Olsen",
                        "Radium","Mt. Robson","Osoyoos",
                        "Dawson Creek",
                        "Pacific")) %>% 
  group_by(Year, Station) %>% 
  summarise(NumberInsp = n()) %>% 
  group_by(Station) %>% 
  mutate(TotalInsp = sum(NumberInsp)) %>% 
  ungroup() %>% 
  arrange(desc(TotalInsp),desc(NumberInsp)) %>% 
  mutate(Station = fct_inorder(Station)) %>% 
  ggplot() + 
  geom_col(aes(x=Station,y=NumberInsp,fill=Year), width = 0.40,position=position_dodge(preserve = "single")) +
  scale_y_continuous(name = "Number of Inspections",
                     breaks = c(0,1000,2500,5000,7500,10000,15000)) +
  theme_classic() +
  labs(x = "") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

p3.x

ggsave("Fig3x_TotalInspections_2019_to_2021_All_Stations.jpg",p3.x)
```

### Figure 4 Total Number of Jurisdictions

```{r fig4_total_number_jurisdictions}
p4 = dat %>%
  filter(!Station %in% c("Scheduled Inspection","Other","Penticton Roving")) %>% 
  group_by(Station,Previous_Waterbody_1_Province_Or_State) %>% 
  summarise(Different_Sources = n()) %>% 
  summarise(TotalSources = n()) %>% 
  arrange(desc(TotalSources)) %>% 
  left_join(station_types) %>% 
  mutate(Station = factor(Station,levels = .$Station)) %>% 
  ggplot() + 
  geom_col(aes(x=Station,y=TotalSources, fill = StationType),width = 0.40) +
  geom_text(aes(x=Station,y=TotalSources+0.05*max(TotalSources),label=TotalSources)) +
  labs(y = "Number of Origin Jurisdictions") + 
  theme_classic() + 
  scale_fill_brewer(palette = "Dark2") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p4

ggsave("Fig4_Total_Jurisdictions_by_Station.jpg",p4)
```

### Figure 5 Number of Inspections and Total Effort by month

```{r fig5_total_inspections_and_total_effort_by_month}
p5 = ggarrange(dat %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  #Calculate the number of inspections for each month
  group_by(the.month) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.month,y=Number_Insp),fill = "#5f6a6f",width = 0.40) +
  geom_text(aes(x=the.month,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  labs(x = "", y = "Watercraft Encounters (# of inspections)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  
  dat %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  group_by(the.month) %>% 
  select(the.month,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalEffort = sum(Shift_hours)) %>% 
  ggplot() + 
  geom_col(aes(x=the.month,y=TotalEffort),fill = "#5f6a6f",width = 0.40) +
  geom_text(aes(x=the.month,y=TotalEffort+max(TotalEffort)*0.05,
                label=round(TotalEffort,0))) +
  theme_classic() +
  labs(x = "", y = "Total Effort (hours)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  ncol = 2, nrow = 1)

p5

ggsave("Fig5_NumberInspections_and_TotalEffort_month.jpg",p5)
```

### Figure 6 Encounter Frequency by Month

```{r fig6_EncounterFrequency_by_month}
p6 = dat %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  mutate(the.day = day(TimeOfInspection)) %>% 
  #Calculate the number of inspections for each month
  group_by(the.month,the.day) %>% 
  summarise(Number_Insp = n()) %>% 
  left_join(
  dat %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  mutate(the.day = day(TimeOfInspection)) %>% 
  group_by(the.month,the.day) %>% 
  select(the.month,the.day,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalEffort = sum(Shift_hours))
  ) %>% 
  mutate(EncounterFreq = Number_Insp/TotalEffort) %>%
  mutate(StandardError = plotrix::std.error(EncounterFreq)) %>% 
  #Summarise for each month
  group_by(the.month,StandardError) %>% 
  summarise(EncounterFreq = mean(EncounterFreq)) %>% 
  #If the bottom half of the errorbar would be below 0, change to 0.
  mutate(StandardError = case_when(
    EncounterFreq - StandardError <= 0 ~ EncounterFreq,
    T ~ StandardError
  )) %>% 
  ggplot() + 
  geom_col(aes(x=the.month,y=EncounterFreq),fill = "#5f6a6f",width = 0.40) +
  geom_errorbar(aes(x=the.month,
                  ymin = EncounterFreq-StandardError,
                  ymax = EncounterFreq+StandardError),width = 0.15) +

  geom_text(aes(x=the.month,y=EncounterFreq,
                label=round(EncounterFreq,1)),nudge_x = 0.4) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency") +
  scale_y_continuous(breaks = seq(0,6.5,0.5))

p6

ggsave("Fig6_EncounterFrequency_by_month.jpg",p6)
```

### Figure 7 Total Inspections and Total Effort by Day of Week

```{r fig7_total_inspections_and_total_effort_by_day_of_week}
p7 = ggarrange(dat %>% 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) %>% 
  #Calculate the number of inspections for each month
  group_by(the.day) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.day,y=Number_Insp),fill = "#5f6a6f",width = 0.40) +
  geom_text(aes(x=the.day,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  labs(x = "", y = "Watercraft Encounters (# of inspections)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
                dat %>% 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) %>% 
  group_by(the.day) %>% 
  select(the.day,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalEffort = sum(Shift_hours)) %>% 
  ggplot() + 
  geom_col(aes(x=the.day,y=TotalEffort),fill = "#5f6a6f",width = 0.40) +
  geom_text(aes(x=the.day,y=TotalEffort+max(TotalEffort)*0.05,
                label=round(TotalEffort,0))) +
  theme_classic() +
  labs(x = "", y = "Total Effort (hours)") +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)),
  ncol = 2, nrow = 1)

p7

ggsave("Fig7_NumberInspections_and_TotalEffort_day.jpg",p7)
```

### Fig 8 Encounter Frequency by day of week

```{r fig8_Encounter_Frequency_by_day_of_week}
#This one requires grouping the data by the week number in the year (i.e. 1,2, 3 ... up to 54) and the day of the week to first calculate the standard error within each day of the week (which is the eventual grouping factor for the figure), then summarise by day of the week the calculate mean frequency.
p8 = dat %>% 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) %>% 
  mutate(the.week = week(TimeOfInspection),
         Month = month(TimeOfInspection)) %>% 
  #Calculate the number of inspections for each month
  group_by(Month,the.week,the.day) %>% 
  summarise(Number_Insp = n()) %>% 
  left_join(
    dat %>% 
  mutate(the.day = wday(TimeOfInspection,label=T,abbr=F,week_start = getOption("lubridate.week.start", 1))) %>% 
  mutate(the.week = week(TimeOfInspection),
         Month = month(TimeOfInspection)) %>% 
  group_by(Month,the.week,the.day) %>% 
  select(Month,the.week,the.day,Shift_ID,Shift_hours) %>% 
  distinct() %>% 
  #Some shifts report negative # of hours... remove those.
  filter(Shift_hours > 0) %>% 
  summarise(TotalEffort = sum(Shift_hours))
  ) %>% 
  mutate(EncounterFreq = Number_Insp/TotalEffort) %>%
  group_by(the.day) %>% 
  mutate(StandardError = plotrix::std.error(EncounterFreq)) %>% 
  mutate(EncounterFreq = mean(EncounterFreq,na.rm=T)) %>% 
  select(the.day,EncounterFreq,StandardError) %>% 
  distinct() %>% 
  ggplot() + 
  geom_col(aes(x=the.day,y=EncounterFreq),fill = "#5f6a6f",width = 0.40) +
  geom_errorbar(aes(x=the.day,
                  ymin = EncounterFreq-StandardError,
                  ymax = EncounterFreq+StandardError),width = 0.15) +
  geom_text(aes(x=the.day,y=EncounterFreq,
                label=round(EncounterFreq,1)),nudge_x = 0.4) +
  theme_classic() +
  labs(x = "", y = "Encounter Frequency") +
  scale_y_continuous(breaks = seq(0,6.5,0.5))

p8

ggsave("Fig8_EncounterFrequency_day_of_week.jpg",p8)

```

### Figure 9 Total Inspections by Time of Day

```{r fig9_total_inspections_by_time_of_day}
p9 = dat %>% 
  mutate(the.hour = hour(TimeOfInspection)) %>%
  group_by(the.hour) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = "#5f6a6f",
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9

ggsave("Fig9_NumberInspections_hour_of_day.jpg",p9)
```

### Figure 9. Part 2 High-Risk Inspections by Time of Day

```{r fig9_HR_inspections_by_time_of_day}
p9.2 = dat %>% 
  filter(High_Risk_AIS_Ind == T) %>% 
  mutate(the.hour = hour(TimeOfInspection)) %>%
  group_by(the.hour) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = "#5f6a6f",
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.2

ggsave("Fig9_Part2_Number_Highrisk_Inspections_hour_of_day.jpg",p9.2)
```

### Figure 9. Part 3 Total Inspections by Time of Day for Golden Station

```{r fig9_Golden_inspections_by_time_of_day}
p9.3 = dat %>% 
  filter(Station == "Golden") %>% 
  mutate(the.hour = hour(TimeOfInspection)) %>%
  group_by(the.hour) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = "#5f6a6f",
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.3

ggsave("Fig9_Part3_Number_Inspections_Golden_hour_of_day.jpg",p9.3)
```


### Figure 9. Part 4 High-Risk Inspections by Time of Day for Golden Station

```{r fig9_HR_Golden_inspections_by_time_of_day}
p9.4 = dat %>% 
  filter(High_Risk_AIS_Ind == T,
         Station == "Golden") %>% 
  mutate(the.hour = hour(TimeOfInspection)) %>%
  group_by(the.hour) %>% 
  summarise(Number_Insp = n()) %>% 
  ggplot() + 
  geom_col(aes(x=the.hour,y=Number_Insp),fill = "#5f6a6f",
           width = 0.40) +
  geom_text(aes(x=the.hour,y=Number_Insp+max(Number_Insp)*0.05,
                label=round(Number_Insp,0))) +
  theme_classic() +
  scale_x_continuous(breaks = seq(0,23,1)) +
  labs(x = "", y = "Watercraft Encounters (# of inspections)")

p9.4

ggsave("Fig9_Part4_Number_Highrisk_Inspections_Golden_hour_of_day.jpg",p9.4)
```

### Figure 11 Destination Waterbodies with Percent

```{r fig11_Destination_Waterbodies_with_percent}
p11 = dat %>% 
  filter(!is.na(Destination_Waterbody_1_Name)) %>% 
  group_by(Destination_Waterbody_1_Name) %>% 
  summarise(NumberInsp = n()) %>% 
  arrange(desc(NumberInsp)) %>% 
  mutate(TotalInsp = sum(NumberInsp)) %>% 
  mutate(Percent = 100*NumberInsp/TotalInsp) %>% 
  slice(1:15) %>% 
  mutate(Destination_Waterbody_1_Name = factor(Destination_Waterbody_1_Name,levels = .$Destination_Waterbody_1_Name)) %>%
  ggplot() + 
  geom_col(aes(x=Destination_Waterbody_1_Name,
               y=Percent),fill = "#5f6a6f", width = 0.40) +
  geom_text(aes(x=Destination_Waterbody_1_Name,
                y=Percent+max(Percent)*0.05,
               label=paste0(round(Percent,1),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent of Total Inspections") + 
  theme(axis.text.x = element_text(angle = 45,hjust=1,vjust=1))

p11

ggsave("Fig11_DestinationWaterbody_Percent_Inspections.jpg",p11)
```

### Figure 12 Percent Compliance by station

```{r fig12_percent_compliance_by_station}
p12 = dat %>% 
  filter(!Station %in% c("Scheduled Inspection",
                         "Other","Penticton Roving")) %>% 
  group_by(Station,Shift_ID) %>% 
  summarise(NumberInsp = n()) %>% 
  #Add number of non-motorized blow-bys per unique station / shift combo.
  left_join(dat %>% 
              group_by(Station,Shift_ID) %>% 
              mutate(Non_Motorized_Blow_Bys_Counter = as.numeric(Non_Motorized_Blow_Bys_Counter)) %>% 
              select(Station,Shift_ID,Non_Motorized_Blow_Bys_Counter) %>% 
              distinct()) %>% 
  #Add number of motorized blow-bys per unique station / shift combo.
  left_join(dat %>% 
              group_by(Station,Shift_ID) %>% 
              mutate(Motorized_Blow_Bys_Counter = as.numeric(Motorized_Blow_Bys_Counter)) %>% 
              select(Station,Shift_ID,Motorized_Blow_Bys_Counter) %>% 
              distinct()) %>% 
  group_by(Station) %>% 
  summarise(NumberInsp = sum(NumberInsp),
            Non_Motorized_Blow_Bys_Counter = sum(Non_Motorized_Blow_Bys_Counter),
            Motorized_Blow_Bys_Counter = sum(Motorized_Blow_Bys_Counter)) %>% 
  group_by(Station) %>% 
  summarise(PercentCompliance = 100*NumberInsp/(NumberInsp + Non_Motorized_Blow_Bys_Counter + Motorized_Blow_Bys_Counter)) %>% 
  arrange(desc(PercentCompliance)) %>% 
  left_join(station_types) %>% 
  mutate(Station = factor(Station, levels = .$Station)) %>% 
  ggplot() + 
  geom_col(aes(x=Station,
               y=PercentCompliance, fill = StationType), width = 0.40) +
  geom_text(aes(x=Station,
                y=PercentCompliance+max(PercentCompliance)*0.05,
               label=paste0(round(PercentCompliance,0),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent Compliance") + 
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

  
p12

ggsave("Fig12_PercentCompliance_Station.jpg",p12)
```

### Figure 13 Noncompliant Watercraft Breakdown
```{r fig13_noncompliant_breakdown}
p13 = dat %>% 
  filter(!Station %in% c("Scheduled Inspection",
                         "Penticton Roving",
                         "Okanagan",
                         "Osoyoos",
                         "Other")) %>% 
  group_by(Station,Shift_ID) %>% 
  mutate(nonm = as.numeric(Non_Motorized_Blow_Bys_Counter)) %>% 
  select(Station,Shift_ID,nonm) %>% 
  distinct() %>% 
  #Add number of motorized blow-bys per unique station / shift combo.
  left_join(dat %>% 
              group_by(Station,Shift_ID) %>% 
              mutate(m = as.numeric(Motorized_Blow_Bys_Counter)) %>% 
              select(Station,Shift_ID,m) %>% 
              distinct()) %>% 
  mutate(Total_Blowbys = nonm + m) %>% 
  group_by(Station) %>% 
  summarise(Total_Blowbys = sum(Total_Blowbys),
            nonm = sum(nonm),
            m = sum(m)) %>% 
  group_by(Station) %>% 
  summarise(`Non-Motorized` = 100*nonm/Total_Blowbys,
            Motorized = 100*m/Total_Blowbys) %>% 
  arrange(desc(`Non-Motorized`)) %>% 
  mutate(Station = factor(Station, levels = .$Station)) %>% 
  pivot_longer(cols = -Station) %>% 
  ggplot() + 
  geom_col(aes(x=Station,
               y=value,
               fill = name),
           col = "black",
           width = 0.40,
           position = "stack") +
  theme_classic() +
  labs(x = "",y = "Percent Blow-bys", fill = "") + 
  scale_fill_manual(values = c("Non-Motorized" = "#5f6a6f",
                               "Motorized" = "grey")) +
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

  
p13 

ggsave("Fig13_Percent_Blowbys_Station.jpg",p13)
```

### Figure 14 Percent Watercraft Inspected with Previous Inspection

```{r fig14_percent_watercraft_insp_with_prev_insp}
p14 = dat %>% 
  filter(!Station %in% c("Scheduled Inspection",
                         "Okanagan",
                         "Other", "Penticton Roving")) %>% 
  group_by(Station) %>% 
  summarise(TotalInsp = n()) %>% 
  left_join(dat %>% 
              filter(Previous_Inspection_Ind == T) %>% 
              group_by(Station) %>% 
              summarise(PrevInspected = n())
            ) %>% 
  mutate(PercPrevInsp = 100*PrevInspected/TotalInsp) %>% 
  arrange(desc(PercPrevInsp)) %>% 
  left_join(station_types) %>% 
  mutate(Station = factor(Station, levels = .$Station)) %>% 
  ggplot() + 
  geom_col(aes(x=Station,
               y=PercPrevInsp, fill = StationType), width = 0.40) +
  geom_text(aes(x=Station,
                y=PercPrevInsp+max(PercPrevInsp)*0.1,
               label=paste0(round(PercPrevInsp,0),"%"))) +
  theme_classic() +
  labs(x = "",y = "Percent Previously Inspected") + 
  scale_y_continuous(breaks = seq(0,100,10), 
                     limits = c(0,100),
                     labels = paste0(seq(0,100,10),"%")) +  
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1)) + 
  scale_fill_brewer(palette = "Dark2")

  
p14

ggsave("Fig14_Percent_Intercepted_with_Prev_Insp.jpg",p14)
```

### Figure 15 Frequency of Previously Inspected Watercraft's Inspections

```{r fig15_prev_insp_watercraft_insp_time}
#Remove Penticton Roving
p15 = dat %>% 
  filter(!Station %in% c("Scheduled Inspection",
                         "Other","Penticton Roving")) %>% 
  ungroup() %>% 
  filter(Previous_Inspection_Ind == T) %>% 
  filter(!is.na(Previous_Inspection_Days_Count)) %>% 
  mutate(previnsp = as.numeric(Previous_Inspection_Days_Count)) %>% 
  select(Station, previnsp) %>% 
  mutate(Timeperiod = as.numeric(cut(previnsp, breaks = c(-1,0.1,30,365,10000)))) %>% 
  mutate(Timeperiod_name = case_when(
    Timeperiod == 1 ~ "Same Day",
    Timeperiod == 2 ~ "< 30 Days",
    Timeperiod == 3 ~ "> 30 Days",
    Timeperiod == 4 ~ "> 1 Year",
    T ~ "Unknown"
  )) %>% 
group_by(Station, Timeperiod_name) %>% 
  summarise(NumberInsp = n()) %>% 
  mutate(TotalInsp = sum(NumberInsp)) %>% 
  mutate(PercInsp = 100*NumberInsp/TotalInsp) %>% 
  mutate(Timeperiod_name = factor(Timeperiod_name, 
                                  levels = c("Same Day",
                                             "< 30 Days",
                                             "> 30 Days",
                                             "> 1 Year"))) %>% 
  arrange(Station,Timeperiod_name) %>% 
  select(Station,Timeperiod_name,PercInsp) %>% 
  ggplot() +
  geom_col(aes(x=Station,
               y=PercInsp,
               fill = Timeperiod_name),
           width = 0.40,
           position = "stack") +
  theme_classic() +
  labs(x = "",y = "Percent Previously Inspected", fill = "") + 
  scale_fill_manual(values = c("Same Day" = "#ab52c5",
                               "< 30 Days" = "#8b9f4a",
                               "> 30 Days" = "#cc0000",
                               "> 1 Year" = "#2986cc")) +
  scale_y_continuous(breaks = seq(0,100,10), labels = paste0(seq(0,100,10),"%")) + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))


p15 

ggsave("Fig15_Percent_PreviouslyInspected_Date_Bins.jpg",p15)
```

### Figure 16 Total High-risk Inspections over 3 years

```{r fig16_total_HR_insp_3_years}
p16 = dat_hr %>% 
  #Filter for our target year and the 2 years prior
  filter(Year %in% c(my.year-2, my.year-1, my.year)) %>% 
  mutate(the.month = month(TimeOfInspection,label=T,abbr=F)) %>% 
  group_by(Year,the.month) %>% 
  summarise(Number_HR = n()) %>% 
  ungroup() %>% 
  #Add in a row for year-month combos with no records: 2020 April.
  add_row(Year = "2020",the.month = month(4,abbr=F,label=T),Number_HR = 0) %>% 
  group_by(Year) %>% 
  filter(!is.na(the.month)) %>% 
  ggplot() + 
  geom_col(aes(x=the.month,
               y=Number_HR,
               fill = Year), 
           width = 0.40,
           col = "black",
           position = "dodge") +
  geom_text(data = . %>% filter(Year == my.year),
            aes(x=the.month,
                y=Number_HR+max(Number_HR)*0.2,
               label=round(Number_HR,0)),
               nudge_x = 0.15) +
  theme_classic() +
  scale_fill_manual(values = c("darkgrey","lightgrey","black")) +
  labs(x = "",y = "Number of High-Risk Inspections")

p16

ggsave("Fig16_Total_HR_Inspections_3_year_spread.jpg",p16)
```

### Figure 18 Source Locations of High-Risk Inspections

```{r fig18_pie_chart_source_locations_HR_Insp}
#Remove Penticton Roving
fig18_dat = dat_hr %>% 
  filter(Year == my.year) %>% 
  group_by(Previous_Waterbody_1_Province_Or_State) %>% 
  summarise(BoatsFromPlace = n()) %>% 
  mutate(TotalBoats = sum(BoatsFromPlace)) %>% 
  mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats) %>% 
  arrange(desc(PercBoatsFromPlace)) %>% 
  mutate(Grouper = case_when(
    PercBoatsFromPlace >= 2 ~ "MainFig",
    PercBoatsFromPlace < 2 ~ "SecondFig")
  )

fig18_main_dat = fig18_dat %>% 
  filter(Grouper == "MainFig") %>% 
  #Add a row for "Other" (for which we have to add together the others)
  bind_rows(fig18_dat %>% 
              filter(Grouper == "SecondFig") %>% 
              group_by(TotalBoats) %>% 
              summarise(BoatsFromPlace = sum(BoatsFromPlace)) %>% 
              mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats,
                     Previous_Waterbody_1_Province_Or_State = "Other",
                     Grouper = "MainFig")) %>% 
  rename(prop = PercBoatsFromPlace) %>%
  arrange(desc(Previous_Waterbody_1_Province_Or_State)) %>% 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) %>% 
  select(-BoatsFromPlace,-TotalBoats)

fig18_second_dat = fig18_dat %>% 
  filter(Grouper != "MainFig") %>% 
  rename(prop = PercBoatsFromPlace) %>%
  arrange(desc(Previous_Waterbody_1_Province_Or_State)) %>% 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) %>% 
  select(-BoatsFromPlace,-TotalBoats)

p18 = ggarrange(ggplot(fig18_main_dat,
       aes(x = "", y = prop, 
           fill = Previous_Waterbody_1_Province_Or_State)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0) +
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Previous_Waterbody_1_Province_Or_State,"\n",round(prop,1),"%")),
                   color = "black", nudge_x = 1.5) + 
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Source") + 
  ggtitle("Main Sources") +
  theme(legend.position = "none"),
ggplot(fig18_second_dat,
       aes(x = "", y = prop, 
           fill = Previous_Waterbody_1_Province_Or_State)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Previous_Waterbody_1_Province_Or_State,"\n",round(prop,1),"%")), color = "black",nudge_x = 0.7)+
  theme_void() + 
  labs(fill = "Source") + 
  ggtitle("Breakdown of `Other`") +
  theme(legend.position = "none"),
ncol = 2, nrow = 1)

p18 

ggsave("Fig18_Inspection_Source_Pie_Charts.jpg",p18)
```

### Figure 19 Destination Locations of High-Risk Inspections

```{r fig19_pie_chart_destination_locations_HR_Insp}
#Quick aside - Martina wants to know how many of the HR inspections that have "Unknown" recorded in the DestRegion field also have the Source_wb_prov_unknown field toggled as T.

# dat_hr %>%
#     filter(Year == my.year) %>%
#     filter(DestRegion %in% c("unknown","Unknown")) %>%
#     #filter(Destination_Major_City != "None") %>%
#     filter(Unknown_Destination_Waterbody_Ind == T) %>%
#     select(Destination_Waterbody_1_Name,
#            Destination_Waterbody_1_Closest_City,
#            Destination_Major_City,
#            Unknown_Destination_Waterbody_Ind,
#            General_Comment) %>%
#   View(.)
# 
# #Total number of HR 2021 records for which destination region is Unknown.
# dat_hr %>%
#   filter(Year == my.year) %>%
#   filter(DestRegion %in% c("unknown","Unknown")) %>%
#   summarise(Unknown_DestRegion = n())
# 
# #Subset of above: where destination major city is also unknown.
# dat_hr %>%
#     filter(Year == my.year) %>%
#     filter(DestRegion %in% c("unknown","Unknown")) %>%
#     filter(Destination_Major_City != "None") %>%
#   summarise(Unknown_DestRegion = n())
# 
# #Subset of above: where unknown destination waterbody indicator field is TRUE.
# dat_hr %>%
#   filter(Year == my.year) %>%
#   filter(DestRegion %in% c("unknown","Unknown")) %>%
#   filter(Unknown_Destination_Waterbody_Ind == T) %>%
#   summarise(n())

fig19_dat = dat_hr %>% 
  filter(Year == my.year) %>% 
#Clean up destination regions.
  mutate(DestRegion = case_when(
    str_detect(DestRegion, "Ocean") ~ "Pacific Ocean",
    str_detect(General_Comment, "going to Vancouver") ~ "Lower Mainland",
    str_detect(General_Comment, "to Pacific Ocean") ~ "Pacific Ocean",
    str_detect(General_Comment, "Kelowna") ~ "Okanagan",
    str_detect(General_Comment, "Alaska") ~ "Outside BC",
    str_detect(General_Comment, "Vancouver Island") ~ "Vancouver Island",
    str_detect(General_Comment, "risk of entering BC waters") ~ "Outside BC",
    T ~ DestRegion
  )) %>% 
  group_by(DestRegion) %>% 
  summarise(BoatsFromPlace = n()) %>% 
  mutate(TotalBoats = sum(BoatsFromPlace)) %>% 
  mutate(PercBoatsFromPlace = 100*BoatsFromPlace/TotalBoats) %>% 
  #Add the FLNRO regions...to do this, for each water body name in the FLNRO lookup table, I sort the FLNRO regions based on their
#number, low to high (e.g. 1, 2, 3 -> 7), remove the O and P from regions 7,
#and keep only the first match between a named water body and a region's water body.
  left_join(flnro_lookup %>% 
              rename(DestRegion = GNIS_NAME_) %>% 
              mutate(REGION_G = str_remove(REGION_G,"[A-Z]{1}")) %>% 
              arrange(DestRegion,REGION_G) %>% 
              group_by(DestRegion) %>% 
              slice(1)) %>% 
#Any holes in this lookup table (e.g. cities) should be filled with DestRegion values.
  mutate(REGION_N = case_when(
         is.na(REGION_N) ~ DestRegion,
         T ~ REGION_N)) %>% 
  group_by(REGION_N) %>% 
  summarise(prop = sum(PercBoatsFromPlace))

fig19_main_dat = fig19_dat %>% 
  filter(prop > 2) %>% 
  bind_rows(fig19_dat %>% 
              filter(prop <= 2) %>% 
              summarise(prop = sum(prop)) %>% 
              mutate(REGION_N = "Other")) %>% 
  arrange(desc(REGION_N)) %>% 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)

#Make colour palette that has 9 colours!
dark_pal_9 = brewer.pal(9, name = "Dark2") %>% str_replace("#666666","#d63735")

dark_pal_9 = c(
  `a` = "#1B9E77",
  `b` = "#D95F02",
  `c` = "#7570B3",
  `d` = "#E7298A",
  `e` = "#66A61E",
  `f` = "#E6AB02",
  `g` = "#A6761D",
  `h` = "#d63735",
  `i` = "#2999d2")

darkpal_9_cols <- function(...) {
  cols <- c(...)
  if (is.null(cols))
    return (dark_pal_9)
  dark_pal_9[cols]
}

darkpal_9_cols()

darkpal_9_palette = list("main" = darkpal_9_cols("a","b","c","d","e","f","g","h","i"))

darkpal_9_function <- function(palette = "main", reverse = FALSE, ...) {
  pal <- darkpal_9_palette[[palette]]
  if (reverse) pal <- rev(pal)
  colorRampPalette(pal, ...)
}

scale_fill_darkpal9 <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- darkpal_9_function(palette = palette, reverse = reverse)
  if (discrete) {
    discrete_scale("fill", paste0("darkpal_9_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

p19 = ggarrange(
  ggplot(fig19_main_dat,
       aes(x = "", y = prop, 
           fill = REGION_N)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1, label = paste0(REGION_N,"\n",round(prop,1),"%")), color = "black",nudge_x=0.7,force=20)+
  theme_void() + 
  theme(legend.position = "none") +
  ggtitle("Main Destination Regions") +
  scale_fill_darkpal9() + 
  labs(fill = "Destination Region"),
  
  ggplot(fig19_dat %>% 
           filter(prop <= 2) %>% 
           arrange(desc(REGION_N)) %>% 
           mutate(lab.ypos = cumsum(prop) - 0.5*prop),
       aes(x = "", y = prop, 
           fill = REGION_N)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(REGION_N,"\n",round(prop,1),"%")), color = "black",nudge_x=0.7)+
  theme_void() + 
  theme(legend.position = "none") +
  ggtitle("Breakdown of `Other`") +
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region"),
  nrow = 1, ncol = 2)

p19

ggsave("Fig19_Highrisk_Destination_Regions_Pie_Charts.jpg",p19)
```

### Figure 22 Pie Chart of Total Watercraft Types

```{r fig22_pie_chart_total_watercraft_types}
p22 = dat %>% 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) %>% 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) %>% 
  mutate(value = as.numeric(value)) %>% 
  group_by(name) %>% 
  summarise(NumberBoats = sum(value)) %>% 
  mutate(TotalBoats = sum(NumberBoats)) %>% 
  mutate(PercBoats = 100*NumberBoats/TotalBoats) %>% 
  arrange(desc(name)) %>% 
  mutate(lab.ypos = cumsum(PercBoats) - 0.5*PercBoats) %>% 
  ggplot(aes(x = "", y = PercBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49,
                      label = paste0(name,"\n",round(PercBoats,0),"%")), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p22

ggsave("Fig22_Total_Watercraft_Type_Pie_Chart.jpg",p22)
```

### Figure 23 Pie Chart of High-Risk Watercraft Types

```{r fig23_pie_chart_HR_watercraft_types}
p23 = dat_hr %>% 
  filter(Year == my.year) %>% 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) %>% 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) %>% 
  mutate(value = as.numeric(value)) %>% 
  group_by(name) %>% 
  summarise(NumberBoats = sum(value)) %>% 
  mutate(TotalBoats = sum(NumberBoats)) %>% 
  mutate(PercBoats = 100*NumberBoats/TotalBoats) %>% 
  arrange(desc(name)) %>% 
  mutate(lab.ypos = cumsum(PercBoats) - 0.5*PercBoats) %>% 
  ggplot(aes(x = "", y = PercBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x=1.49, label = paste0(name,"\n",round(PercBoats,0),"%")), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p23

ggsave("Fig23_Highrisk_Watercraft_Type_Pie_Chart.jpg",p23)
```


### Figure 24 Mussel-fouled By Month All Years
```{r fig24_musselfouled_by_month_all_years}
#If an excel sheet can be found in the Final Report > my.year > GIS Maps and Excel Figures folder, use that. We make this excel sheet automatically below, and it can be updated by hand after its creation.

if(file.exists(paste0("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/",my.year,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))){
  mf_time_table = read_excel(paste0("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/",my.year,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))
}

#If that file does not yet exist...
if(!file.exists(paste0("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/",my.year,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))){
#Read in the hand-cleaned excel sheet from 2020 report, and add more recent data to it.
mf_time_table = read_excel("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/2020/GIS Maps and Excel Figures/ExcelFigureData/2019_Fig24_MusselFouled_byMonth_2017-2020.xlsx",sheet = "dat_for_R")

#Add my.year (and any intervening years between 2020 and my.year, if there are any)'s mf data to the excel sheet.
mf_time_table = mf_time_table %>% 
  bind_rows(dat_mf %>% 
    filter(Year %in% 2021:my.year) %>% 
    group_by(Year,Month) %>% 
    summarise(Number = n()) %>% 
    pivot_wider(names_from = Month, values_from = Number) %>% 
    mutate(Year = 2021:my.year)) %>% 
  mutate(across(c(April:November), ~ replace_na(.x, 0))) %>% 
  ungroup()

#Add total back in.
mf_time_table$Total = rowSums(mf_time_table %>% select(-Year,-Total))

#Save the excel file in my.year's folder.
write.xlsx(mf_time_table, paste0("I:/SPECIES/Zebra_Quagga_Mussel/Communications/Inspection data reporting/Final report/",my.year,"/GIS Maps and Excel Figures/Fig24_MusselFouled_byMonth_2017-",my.year,".xlsx"))
}

p24 = mf_time_table %>% 
  pivot_longer(-Year) %>% 
  filter(name != "Total") %>% 
  rename(Month = name) %>% 
  mutate(NumberBoats = as.numeric(value),
         Month = factor(Month,levels = c("April","May","June","July","August","September","October","November"))) %>% 
  mutate(Year = factor(Year, levels = c(2015:my.year))) %>% 
  ggplot() + 
  geom_col(aes(x = Month, y=NumberBoats, fill=Year), col="black", position=position_dodge2(width = 0.5, preserve = "single")) + 
  scale_fill_brewer(palette = "Dark2") + 
  theme_classic() + 
  scale_y_continuous(limits = c(0,8), breaks = seq(0,8,1)) + 
  labs(x = "", y = "Mussel Fouled Boats")

p24

ggsave("Fig24_Musselfouled_by_Month.jpg",p24)

```

### Figure 25 Source Provinces / States for Mussel-fouled Boats
```{r fig25_source_province_states_for_musselfouled}
p25 = dat_mf %>% 
  filter(Year == 2021) %>% 
  rename(prev = Previous_Waterbody_1_Province_Or_State) %>% 
  group_by(prev) %>% 
  summarise(NumberBoats = n()) %>% 
  left_join(abbrev %>% rename(prev = Abbrev)) %>% 
  arrange(desc(prev)) %>% 
  mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) %>% 
  ggplot(aes(x = "", y = NumberBoats, 
           fill = Province_or_State)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Province_or_State,", ",NumberBoats)), 
            color = "black",nudge_x=0.7)+
  theme_void() + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p25

ggsave("Fig25_MusselFouled_Source_Regions_Pie_Charts.jpg",p25)

```

### Figure 26 Destination Regions of Mussel-fouled Inspections

```{r fig26_pie_chart_destination_locations_MF_Insp}
fig26dat = read_excel(MusselFouledTracker,
                      sheet = MF_tracker_sheet)

p26 = fig26dat %>% 
  arrange(desc(Region)) %>% 
  mutate(lab.ypos = cumsum(Number) - 0.5*Number) %>% 
  ggplot(aes(x = "", y = Number, 
           fill = Region)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(Region,"\n",Number)), color = "black",nudge_x=0.2)+
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") +
  theme(legend.position = "none")

p26

ggsave("Fig26_MusselFouled_Destination_Regions_Pie_Charts.jpg",p26)
```

### Figure 28 Pie Chart of Mussel-fouled Watercraft Types

```{r fig28_pie_chart_MF_watercraft_types}
p28 = dat_mf %>% 
  filter(Year == 2021) %>% 
  rename(`Non-motorized / Hand launched` = Non_Motorized_Counter,
         Simple = Simple_Counter,
         Complex = Complex_Counter,
         `Very complex` = Very_Complex_Counter) %>% 
  pivot_longer(cols = c(`Non-motorized / Hand launched`,Simple,
                        Complex,`Very complex`)) %>% 
  mutate(value = as.numeric(value)) %>% 
  group_by(name) %>% 
  summarise(NumberBoats = sum(value)) %>% 
  arrange(desc(name)) %>% 
  mutate(lab.ypos = cumsum(NumberBoats) - 0.5*NumberBoats) %>% 
  ggplot(aes(x = "", y = NumberBoats, 
           fill = name)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text_repel(aes(y = lab.ypos, x = 1.49, label = paste0(name,"\n",NumberBoats)), 
            color = "black",nudge_x=0.4) +
  theme_void() + 
  scale_fill_brewer(palette = "Dark2") + 
  labs(fill = "Destination Region") + 
  theme(legend.position = "none")

p28

ggsave("Fig28_Musselfouled_Watercraft_Type_Pie_Chart.jpg",p28)
```

### Figure 29 Commercially Hauled Boats

```{r fig29_commercially_hauled_boats}
p29 = dat %>% 
  filter(Commercially_Hauled_Ind == T) %>% 
  filter(!Station %in% c("Scheduled Inspection","Penticton Roving")) %>% 
  group_by(Station) %>% 
  summarise(NumberBoats = n()) %>% 
  arrange(desc(NumberBoats)) %>% 
  left_join(station_types) %>% 
  mutate(Station = factor(Station, levels = .$Station)) %>% 
  ggplot() + 
  geom_col(aes(x=Station,y=NumberBoats),fill = "#5f6a6f", width = 0.40) +
  geom_text(aes(x=Station,y=NumberBoats+0.05*max(NumberBoats),label=NumberBoats)) +
  labs(y = "Commercially Hauled Boats") + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))

p29

ggsave("Fig29_Commerically_Hauled_by_Station.jpg",p29)

```

### Figure 30 
```{r fig30_CBSA_Notifications}
cbsa_dat = cbsa_dat %>% 
  filter(!is.na(Categories)) %>% 
  mutate(Categories = str_to_upper(Categories)) %>% 
  mutate(Categories = str_remove_all(Categories, " -")) %>% 
  mutate(Subtype = str_extract(Categories, "(?<=CBSA ).*")) %>% 
  mutate(Categories = str_remove_all(Categories, "(?<=CBSA).*")) %>% 
  mutate(Year = my.year) %>% 
  mutate(Categories = case_when(
    Categories %in% c("NEW BOATS","NEW BOAT SHIPMENT") ~ "NEW BOATS",
    str_detect(Categories, "INVASIVE SPECIES") ~ "ISCBC",
    T ~ Categories
  )) %>% 
  mutate(Subtype = coalesce(Subtype, Categories)) %>% 
  mutate(Categories = case_when(
    Categories %in% c("USA","US","US STATE","ID","MT") ~ "USA",
    Categories %in% c("AB","SK","MB") ~ "PROVINCES",
    T ~ Categories
  )) %>% 
  count(Categories, Subtype, sort = T)

p30 = cbsa_dat %>% 
  group_by(Categories) %>% 
  summarise(group_n = sum(n)) %>%
  ungroup() %>% 
  arrange(group_n) %>% 
  mutate(Categories = fct_inorder(Categories)) %>% 
  ggplot() + 
  geom_col(aes(group_n, Categories, fill = Categories), col = "black") + 
  geom_text(aes(group_n/2, Categories, label = group_n), size = 5) +
  theme_light() +
  theme(text = element_text(size = 16)) +
  theme(legend.position = "none") +
  labs(y = "", x = "Number of Notifications",
       title = "CBSA Notification Categories",
       subtitle = my.year)

p30

ggsave("Fig30_Percent_Previous_Knowledge.jpg",p30)

```

### Figure 32 Previous Knowledge

```{r fig32_previous_knowledge}
#Remove Penticton Roving
fig32_dat = dat %>% 
  filter(!Station %in% c("Scheduled Inspection",
                         "Other","Penticton Roving")) %>% 
  group_by(Station, Previous_AIS_Knowledge_Ind) %>%
  summarise(Number = n()) %>% 
  mutate(TotalPerStation = sum(Number)) %>% 
  mutate(Diff = case_when(
    row_number() %% 2 != 0 ~ Number-lead(Number),
    row_number() %% 2 == 0 ~ -Number + lag(Number))) %>%
  mutate(Diff = 100*Diff/TotalPerStation) %>% 
  arrange(Diff) %>% 
  ungroup() %>% 
  filter(Previous_AIS_Knowledge_Ind == T) %>% 
  left_join(station_types) %>% 
  mutate(Station = factor(Station, levels = .$Station)) %>% 
  ungroup() %>% 
  mutate(prop = 100*Number/TotalPerStation) %>% 
  mutate(StationType_T = paste0(StationType, Previous_AIS_Knowledge_Ind))
  
p32 = ggplot() + 
  geom_col(data = fig32_dat %>% mutate(prop = 100),
           aes(x=Station,y=prop,fill = StationType),
           col = "black", width = 0.4) + 
  #scale_fill_brewer(palette = "Set2") + 
  geom_col(data = fig32_dat, aes(x=Station,y=prop, fill = StationType_T),
           col="black",width = 0.40) +
  labs(y = "Percent Previous Knowledge",fill = "") + 
  theme_classic() + 
  scale_fill_manual(breaks = c("PermanentTRUE","RovingTRUE","Permanent","Roving"),
                    values = c("Permanent" = "#7BD891",
                               "PermanentTRUE" = "#23AD23",
                               "Roving" = "#D87BC2",
                               "RovingTRUE" = "#AD23AD"),
                    labels = c("Permanent - Yes",
                               "Roving - Yes",
                               "Permanent - No",
                               "Roving - No")) +
  # scale_fill_manual(breaks = c("FALSE","TRUE"),
  #                   values = c("TRUE" = RColorBrewer::brewer.pal(3,"Dark2")[1],
  #                              "FALSE" = RColorBrewer::brewer.pal(3,"Dark2")[2]),
  #                   labels = c("Yes","No")) +
  theme(axis.text.x = element_text(angle = 45,vjust=1,hjust=1))
  
p32

ggsave("Fig32_Percent_Previous_Knowledge.jpg",p32)
```

### Figure 33 Primary Sources of Previous Knowledge

```{r fig33_primary_sources_previous_knowledge}
p33 = dat %>% 
  rename(ais_know_id = Previous_AIS_Knowledge_Source_Code_ID) %>% 
  #Join the lookup table for previous AIS knowledge
  left_join(ais_know %>% 
              rename(ais_know_id = `Previous Ais Knowledge Source Code ID`) %>% 
              mutate(ais_know_id = as.character(ais_know_id)) %>% 
              select(Description, ais_know_id)) %>% 
  #Only keep records that have some kind of previous AIS knowledge.
  filter(!is.na(Description)) %>% 
  #Get the number of records for each knowledge source
  group_by(Description) %>% 
  summarise(Number = n()) %>% 
  #Calculate the percentage for each knowledge source
  mutate(Total = sum(Number)) %>% 
  mutate(prop = 100*Number/Total) %>% 
  #Put all knowledge sources below 1% into a single category called 'Other', label the groups for all knowledge sources >= 1% with their descriptions.
  mutate(Grouper = case_when(
    prop >= 1 ~ Description,
    T ~ "Other"
  )) %>% 
  #Add together proportions within each of these groups. This combines the "Other" group.
  group_by(Grouper) %>% 
  summarise(prop = sum(prop)) %>% 
  arrange(desc(Grouper)) %>% 
  mutate(lab.ypos = cumsum(prop) - 0.5*prop) %>% 
  ggplot(aes(x = "", y = prop, 
           fill = Grouper)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text_repel(aes(y = lab.ypos, x = 1.15, label = paste0(round(prop,0), "%")),
                   size = 4.5, nudge_x = 1, force_pull = 0.5,force = 1000) +
  #geom_text(aes(y = lab.ypos, label = paste0(Grouper,", ",round(prop,0),"%")), 
#            color = "black",nudge_x=0.7)+
  theme_void() + 
  labs(fill = "Knowledge Source") +
  scale_fill_brewer(palette = "Dark2")

p33

ggsave("Fig33_Primary_Sources_Previous_AIS_Knowledge.jpg",p33)
```

